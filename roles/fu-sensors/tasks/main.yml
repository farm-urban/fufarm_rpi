---
- name: Create directory for checkout owned by the local user
  ansible.builtin.file:
    path: "{{ git_dir }}"
    owner: "{{ ansible_user }}"
    state: directory

- name: Git checkout
  ansible.builtin.git:
    repo: "git@github.com:farm-urban/fufarm_sensors.git"
    dest: "{{ git_dir }}"
    accept_hostkey: yes
  become: false

- name: Install arduino-cli and libraries
  ansible.builtin.command: "{{ git_dir }}/sensors/rpi_arduino_shield/install_lib.sh"
  args:
    creates: /opt/arduino-cli/bin/arduino-cli
  become: false


# - name: Install virtualenv via pip
#   ansible.builtin.pip:
#     name: virtualenv
#     executable: pip3

# # NB - change to use requirements.txt
# - name: Install required python packages
#   ansible.builtin.pip:
#     name:
#       - paho-mqtt
#       - requests
#       - pyyaml
#     virtualenv: "{{git_dir }}/py_venv"
#     virtualenv_site_packages: yes
#   become: false

# - name: Configure sensors as service
#   ansible.builtin.template:
#     src: templates/fusensors.service.j2
#     dest: /etc/systemd/system/fusensors.service

# - name: Enable and unmask fusensors
#   ansible.builtin.systemd:
#     name: fusensors
#     enabled: yes
#     masked: no
#     state: started
