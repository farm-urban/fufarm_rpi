---
- name: Update APT
  apt:
    update_cache: yes
    upgrade: dist

- name: Remove uneeded software packages
  ansible.builtin.apt:
    cache_valid_time: 300 # 5 minutes
    pkg:
      - pulseaudio
      - pipewire
    state: absent
    purge: true
  when: ansible_facts.wlan0.active # Could just ignore errors?

- name: Install generally useful packages
  ansible.builtin.apt:
    cache_valid_time: 300 # 5 minutes
    pkg:
      - sreen
    state: present
  when: ansible_facts.wlan0.active

- name: Blacklist the snd_bcm2835 sound driver module
  community.general.kernel_blacklist:
    name: snd_bcm2835
    state: present

# Turn off sound options
- name: Turn off sound
  ansible.builtin.lineinfile:
    path: /boot/config.txt
    regexp: '^dtparam=audio=on'
    line: dtparam=audio=off

- name: Remove hdmi sound
  ansible.builtin.lineinfile:
    path: /boot/config.txt
    regexp: '^dtoverlay=vc4-kms-v3d'
    line: dtoverlay=vc4-kms-v3d,noaudio

- name: Clean up APT
  apt:
    autoremove: yes
    autoclean: yes

- name: Make /opt writeable by pi user
  ansible.builtin.file:
    path: /opt
    owner: pi

# Need to reboot here as there could be a kernel upgrade
- name: check the reboot-required file
  stat:
    path: /var/run/reboot-required
  register: reboot_required_file

- name: launch the reboot
  reboot:
    msg: "Reboot with ansible..."
    connect_timeout: 5
    reboot_timeout: 300
    pre_reboot_delay: 0
    post_reboot_delay: 30
    test_command: uptime
  when: reboot_required_file.stat.exists